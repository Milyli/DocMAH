var DMH=DMH||{},docmahJQuery=$.noConflict(!0);DMH.HistoryState=function(){return this.Replace=1,this.Push=2,this.Pop=3,this}();DMH.Urls=function(){return this.DeletePage="/help.axd?m=DeletePage",this.GenerateInstallScript="/help.axd?m=GenerateInstallScript",this.MovePage="/help.axd?m=MovePage",this.NavigateDocumentation="/help.axd?m=DocumentationPage",this.ReadApplicationSettings="/help.axd?m=ReadApplicationSettings",this.ReadPage="/help.axd?m=ReadPage",this.ReadTableOfContents="/help.axd?m=ReadTableOfContents",this.SaveDocumentationPage="/help.axd?m=SaveDocumentationPage",this.SaveFirstTimeHelp="/help.axd?m=SaveFirstTimeHelp",this.SaveUserPageSettings="/help.axd?m=SaveUserPageSettings",this}();DMH.Helpers=function(){return this.GetQueryParameter=function(n){n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var i=new RegExp("[\\?&]"+n+"=([^&#]*)"),t=i.exec(location.search);return t===null?"":decodeURIComponent(t[1].replace(/\+/g," "))},this}();DMH.AjaxClient=function(){var n=docmahJQuery;this.DeletePage=function(t,i){n.ajax({type:"POST",url:DMH.Urls.DeletePage,data:t.toString(),success:i})};this.MovePage=function(t,i,r){n.ajax({type:"POST",url:DMH.Urls.MovePage,data:JSON.stringify({PageId:t,NewParentId:i,NewPosition:r}),async:!1})};this.ReadApplicationSettings=function(t){n.ajax({type:"GET",url:DMH.Urls.ReadApplicationSettings,success:t,async:!1})};this.ReadPage=function(t,i){n.ajax({type:"GET",data:{id:t},url:DMH.Urls.ReadPage,success:i})};this.ReadTableOfContents=function(t){n.ajax({type:"GET",url:DMH.Urls.ReadTableOfContents,success:t})};this.SaveDocumentationPage=function(t,i){n.ajax({type:"POST",contentType:"application/json",dataType:"json",url:DMH.Urls.SaveDocumentationPage,data:JSON.stringify(t),success:i})};this.SaveFirstTimeHelp=function(t,i){n.ajax({type:"POST",contentType:"application/json",dataType:"json",url:DMH.Urls.SaveFirstTimeHelp,data:JSON.stringify(t),success:i})};this.SaveUserPageSettings=function(t){n.ajax({type:"POST",contentType:"application/json",dataType:"json",url:DMH.Urls.SaveUserPageSettings,data:JSON.stringify(t)})}};DMH.AnchoredElementLogic=function(){var t=this,i=new DMH.SharedElements,n=docmahJQuery;this.UpdateElementPosition=function(t,i){if(i.length>0){var f=n("#"+t.OffsetElementId).offset(),r=f?f.top+t.VerticalOffset:0,u=f?f.left+t.HorizontalOffset:0;u+i.width()>n(document).width()&&(u=n(document).width()-i.width());u<0&&(u=0);r+i.height()>n(document).height()&&(r=n(document).height()-i.height());r<0&&(r=0);i.css({top:r,left:u})}};this.UpdateElementPositions=function(r,u){i.$getModalMask().is(":visible")&&(n.each(r.Bullets,function(i,r){t.UpdateElementPosition(r,n("#dmhDraggableBullet-"+r.Number));t.UpdateElementPosition(r,n("#dmhPlacedBullet-"+r.Number))}),u.is(":visible")&&t.UpdateElementPosition(r,u))}};DMH.Cookies=function(){this.DeleteCookie=function(n){document.cookie=n+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"};this.GetCookie=function(n){for(var t,r=n+"=",u=document.cookie.split(";"),i=0;i<u.length;i++){for(t=u[i];t.charAt(0)===" ";)t=t.substring(1);if(t.indexOf(r)===0)return t.substring(r.length,t.length)}return""};this.SetCookie=function(n,t,i){var r=new Date,u=n+"="+t,f;i&&(r.setTime(r.getTime()+i*864e5),f="expires="+r.toUTCString(),u=u+"; "+f);document.cookie=u}};DMH.DocumentationPage=function(){function it(){return n("#dmhCancelButton")}function h(){return n("#dmhDeletePageButton")}function c(){return n("#dmhDocumentationEditor")}function b(){return n("#dmhDocumentationEditorContent")}function k(){return n("#dmhDocumentationEditorTitle")}function l(){return n("#dmhDocumentationView")}function rt(){return n("#dmhDocumentationViewContent")}function ut(){return n("#dmhDocumentationViewTitle")}function a(){return n("#dmhEditPageButton")}function d(){return n("#dmhEditModeButtonBar")}function v(){return n("#dmhEditToolBar")}function ft(){return n("#dmhGenerateInstallScriptButton")}function y(){return n("#dmhIsHidden")}function et(){return n("#dmhLeftContainer")}function ot(){return n("#dmhNewPageButton")}function st(){return n("#dmhRightContainer")}function ht(){return n("#dmhSaveButton")}function i(){return n("#dmhToc")}function g(){return n("#dmhViewModeButtonBar")}function p(n,i){var u,f;i=i||DMH.HistoryState.Push;u=s(n.id);u&&(!t||t.Id!==u)&&(f=new DMH.AjaxClient,f.ReadPage(u,function(t){var u="help.axd?m=DocumentationPage&id="+t.Id;i===DMH.HistoryState.Replace?(t.HistoryId=r,history.replaceState(t,t.Title,u)):i===DMH.HistoryState.Push?(t.HistoryId=++r,history.pushState(t,t.Title,u)):i===DMH.HistoryState.Pop&&(t.HistoryId=r);tt(n);o(t)}))}function s(n){return n==="#"?null:parseInt(n.substring(12))}function nt(){if(u&&u.CanEdit){h().hide();v().hide();d().hide();a().hide();g().show();t&&(h().show(),a().show(),y().prop("disabled",!0).prop("checked",t.IsHidden));v().show();var n=v().innerHeight()+"px";et().css("bottom",n);st().css("bottom",n)}}function ct(){if(t){var r=new DMH.AjaxClient;r.SaveDocumentationPage(t,function(){var r=i().jstree("get_node","dmhTocEntry-"+t.Id);i().jstree("rename_node",r,t.Title);t.IsHidden?(r.li_attr["class"]="tocHidden",n("#"+r.id).addClass("tocHidden")):(r.li_attr["class"]="",n("#"+r.id).removeClass("tocHidden"));e("Page saved.","success");o(t)})}}function tt(n){var t=i().jstree(),r=t.get_selected(!0);t.deselect_node(r);t.select_node(n)}function e(t,i){var r="dmhStatusWarning",u;i==="success"&&(r="dmhStatusSuccess");u=n("#dmhStatusMessage");u.html(t).addClass(r).show().delay(2e3).fadeOut("slow",function(){u.removeClass(r)})}function o(i){t=i;w=n.extend(!0,{},i);l().hide();c().hide();i&&(ut().html(t.Title),rt().html(t.Content),l().show(),c().hide());nt()}function lt(){e("Changes canceled.","warning");o(w)}function at(){var o;if(t){var f=t.Id,r=i().jstree(),u=r.get_node("dmhTocEntry-"+f);n.each(u.children,function(n,t){r.move_node(t,u.parent,"last")});r.delete_node(u);o=new DMH.AjaxClient;o.DeletePage(f,function(){e("Page deleted.","success")})}}function vt(){g().hide();d().show();y().prop("disabled",!1);k().val(t.Title);b().val(t.Content);l().hide();c().show()}function yt(){window.open(DMH.Urls.GenerateInstallScript)}function pt(){var n=i().jstree();n.create_node("#",{text:"New Page"},"last",function(t){e("Page created.","success");setTimeout(function(){n.edit(t)},0)})}function wt(t){var r,f,e;if(n.each(t,function(t,r){var u='<li id="dmhTocEntry-'+r.Id+'" class="dmhTocEntry'+(r.IsHidden?" tocHidden":"")+'">';u+=r.Title;u+="<ul><\/ul><\/li>";r.ParentPageId?n("#dmhTocEntry-"+r.ParentPageId+">ul").append(u):i().find(">ul").append(u)}),r=["wholerow","state"],f={core:{check_callback:!0,multiple:!1,themes:{icons:!1}},plugins:r},u.CanEdit&&r.push("dnd"),e=i().jstree(f).on("activate_node.jstree",kt).on("ready.jstree",ii),u.CanEdit)e.on("create_node.jstree",dt).on("delete_node.jstree",gt).on("move_node.jstree",ni).on("rename_node.jstree",ti)}function bt(){t.IsHidden=y().prop("checked");t.Title=k().val();t.Content=b().val();ct()}function kt(n,t){p(t.node)}function dt(n,t){var i={ParentPageId:s(t.parent),Order:t.position,Title:"New Page",Content:""},r=new DMH.AjaxClient;r.SaveDocumentationPage(i,function(n){t.instance.set_id(t.node,"dmhTocEntry-"+n.Id);f=n})}function gt(t,i){var u=null,f,r;i.node.parent==="#"?(f=n(".dmhTocEntry"),f.length>0&&(r=f.get(0).id,r===i.node.id&&(r=null,f.length>1&&(r=f.get(1).id)),r&&(u=i.instance.get_node(r)))):i.node.parent&&(u=i.instance.get_node(i.node.parent));u?(i.instance.select_node(u),p(u,DMH.HistoryState.Replace)):o(null)}function ni(n,i){var r=s(i.node.id),u=s(i.parent),f=new DMH.AjaxClient;f.MovePage(r,u,i.position);t.Id===r&&(t.ParentPageId=u,t.Order=i.position)}function ti(n,t){if(f){f.Title=t.text;var i=new DMH.AjaxClient;i.SaveDocumentationPage(f,function(){e("Page renamed.","success")});f=null}}function ii(n,t){var r=null,f=DMH.Helpers.GetQueryParameter("id"),u;f&&(r=i().jstree("get_node","dmhTocEntry-"+f));r||(u=t.instance.get_selected(!0),u&&u.length>0&&(r=u[0]));r&&p(r,DMH.HistoryState.Replace)}function ri(n){var t=n.state,f=t.HistoryId>r,u;f?r++:r--;u=i().jstree("get_node","dmhTocEntry-"+t.Id);u?(tt(u),o(t)):f?history.forward():history.back()}var u=null,t=null,f=null,w=null,r=1,n=docmahJQuery;this.Initialize=function(){var n=new DMH.AjaxClient;n.ReadApplicationSettings(function(n){u=n;nt()});n.ReadTableOfContents(wt);it().click(lt);h().click(at);a().click(vt);ft().click(yt);ot().click(pt);ht().click(bt);window.onpopstate=ri}};DMH.HelpButton=function(){function t(){return n(".dmhHelpButton")}function r(n){i=n;n?t().attr("Title","Show help for this page"):t().attr("Title","View documentation")}function f(){i?n(u).trigger("showFirstTime.dmh"):window.open(DMH.Urls.NavigateDocumentation,"_blank")}var u=this,i=null,n=docmahJQuery;this.Initialize=function(i,u){r(u);n(i).bind("pageUpdate.dmh",function(n,t){r(t)});t().click(f)}};DMH.FirstTimeEdit=function(){function ft(){return n("#dmhAddBulletButton")}function et(t){return n(".dmhBulletEdit",t)}function w(){return n("#dmhBulletEditTemplate")}function b(t){return n(".dmhBulletEditText",t)}function ot(){return n("#dmhCancelHelpButton")}function r(){return n("#dmhCreateHelpButton")}function o(){return n(".dmhDialogTitle")}function k(t){return n(">.dmhDraggableBullet",t)}function s(t){return n(".dmhDraggableBulletNumber",t)}function i(){return n("#dmhFirstTimeEdit")}function f(){return n("#dmhFirstTimeEditBullets")}function h(){return n("#dmhFirstTimeEditContent")}function c(){return n("#dmhFirstTimeEditMatchUrls")}function l(){return n("#dmhFirstTimeEditTitle")}function a(){return n("#dmhSaveHelpButton")}function d(t){var i=w().clone(!0,!0).attr("id","dmhBulletEdit-"+t.Number),r,u,e,o;i.find(".dmhBulletNumber").html(t.Number);t.Text&&b(i).val(t.Text);f().append(i);r=k(i);s(r).html(t.Number);r.detach();n("body").append(r);t.OffsetElementId?(o=n("#"+t.OffsetElementId).offset(),u=o.top+t.VerticalOffset,e=o.left+t.HorizontalOffset):(u=i.offset().top-3,e=i.offset().left-50);r.attr("id","dmhDraggableBullet-"+t.Number).css({top:u+"px",left:e+"px"}).draggable({containment:"document",stop:vt});tt(r.get(0))}function g(){k("body").remove();i().hide();y.$getModalMask().hide();r().show()}function st(){a().html("Create");o().html("Create Help Page");l().val("Help - "+document.title);c().val(window.location.pathname);h().val("");f().empty();var t=n(document).width()/3*2-i().width();i().css({top:"200px",left:t})}function ht(t){a().html("Save");o().html("Edit Help Page");l().val(t.Title);c().val(t.MatchUrls);h().val(t.Content);f().empty();n.each(t.Bullets,function(n,t){d(t)});var r=n("#"+t.OffsetElementId),u=r.offset().top+t.VerticalOffset+"px",e=r.offset().left+t.HorizontalOffset+"px";i().css({top:u,left:e})}function nt(t){var e=n(t),i=e.offset().left,o=i+e.width(),s=(o-i)/2+i,r=e.offset().top,h=r+e.height(),c=(h-r)/2+r,f=null;return u.each(function(t,u){var e=n(u),o=e.offset().left,a=o+e.width(),v=(a-o)/2+o,h=e.offset().top,y=h+e.height(),p=(y-h)/2+h,l=Math.sqrt(Math.pow(Math.abs(s-v),2)+Math.pow(Math.abs(c-p),2));f?l<f.Distance&&(f={Distance:l,HorizontalOffset:Math.round(i-o),VerticalOffset:Math.round(r-h),OffsetElementId:e.attr("id")}):f={Distance:l,HorizontalOffset:Math.round(i-o),VerticalOffset:Math.round(r-h),OffsetElementId:e.attr("id")}}),f}function tt(i){var u=nt(i),f=parseInt(s(n(i)).html()),r;n.each(t.Bullets,function(n,t){t.Number===f&&(r=t)});r.HorizontalOffset=u.HorizontalOffset;r.VerticalOffset=u.VerticalOffset;r.OffsetElementId=u.OffsetElementId}function it(n){var i=nt(n);t.HorizontalOffset=i.HorizontalOffset;t.VerticalOffset=i.VerticalOffset;t.OffsetElementId=i.OffsetElementId}function v(){var i=window.location.href,r=window.location.host,u=i.substring(i.indexOf(r)+r.length,i.length);t.Id=t.Id||0;t.Title=l().val();t.MatchUrls=c().val();t.SourceUrl=u;t.Content=h().val();n.each(t.Bullets,function(t,i){i.Text=b(n("#dmhBulletEdit-"+(t+1))).val()})}function ct(){var n={Number:t.Bullets.length+1};t.Bullets.push(n);d(n)}function lt(){t=p;g()}function at(){t&&(p=n.extend(!0,{},t));t?ht(t):(t={Bullets:[]},st());r().hide();y.$getModalMask().show();var u=i().show();it(u.get(0))}function vt(){tt(this);v()}function yt(){it(this);v()}function pt(){var i=n(this).closest(".dmhBulletEdit"),r=i.find(".dmhBulletNumber").html();i.remove();n("#dmhDraggableBullet-"+r).remove();et(f()).each(function(t,i){var r=t+1,u=n(i).find(".dmhBulletNumber"),e=u.html(),f;u.html(r);n(i).attr("id","dmhBulletEdit-"+r);f=n("#dmhDraggableBullet-"+e).attr("id","dmhDraggableBullet-"+r);s(f).html(r)});t.Bullets.splice(r-1,1);n.each(t.Bullets,function(n,t){t.Number=n+1})}function wt(){v();var i=new DMH.AjaxClient;i.SaveFirstTimeHelp(t,function(n){t.Id=n.Id});r().html("Edit Help Page");g();n(ut).trigger("pageUpdate.dmh",t)}function bt(){rt.UpdateElementPositions(t,i())}var rt=new DMH.AnchoredElementLogic,e=null,t=null,y=new DMH.SharedElements,u=null,p=null,ut=this,n=docmahJQuery;this.Initialize=function(f,s){e=f;t=s;e&&e.CanEdit&&(a().click(wt),ot().click(lt),ft().click(ct),w().find(".dmhButtonCancel").click(pt),i().draggable({handle:o(),containment:"document",stop:yt}),u=n("*[id]:visible:not(.dmh-,.dmh- *,link,meta,script,style,:has(*))"),u.length===0&&(u=n("*[id]:visible:not(.dmh-,.dmh- *,link,meta,script,style)")),u.length===0?r().html("Cannot Create Help").attr("title","Click for more information.").click(function(){alert("DocMAH was unable to find elements to anchor to. Please add IDs to elements you wish to place help near.")}):(t&&r().html("Edit Help Page"),r().click(at)));n(window).resize(bt)}};DMH.FirstTimeView=function(){function y(t){return n(".dmhBulletNumber",t)}function p(){return n("#dmhBulletViewTemplate")}function w(t){return n(".dmhBulletViewText",t)}function b(){return n("#dmhCloseHelpButton")}function k(){return n(".dmhDialogTitle")}function d(){return n("#dmhHideHelpButton")}function g(t){return n(".dmhPlacedBulletNumber",t)}function s(t){return n(">.dmhPlacedBullet",t)}function u(){return n("#dmhFirstTimeView")}function h(){return n("#dmhFirstTimeViewBullets")}function nt(){return n("#dmhFirstTimeViewContent")}function c(){return n("#dmhShowDocumentationButton")}function tt(n){null===i?i={PageId:t.Id,HidePage:n}:i.HidePage=n;var r=new DMH.AjaxClient;r.SaveUserPageSettings(i)}function it(t){var f=n("body"),r=n("#"+t.OffsetElementId).offset(),e=r?r.top+t.VerticalOffset:0,c=r?r.left+t.HorizontalOffset:o,u=p().clone(!0,!0).attr("id","dmhBulletView-"+t.Number),i;y(u).html(t.Number);w(u).html(t.Text);h().append(u);i=s(u);g(i).html(t.Number);i.detach();f.append(i);i.attr("id","dmhPlacedBullet-"+t.Number).css({top:e,left:c})}function l(){s(n("body")).remove()}function a(n){n.data.model.ClosePage();var t=new DMH.Cookies;t.SetCookie("DMH-HideHelp",n.data.hide.toString(),730);tt(n.data.hide)}function rt(){f.UpdateElementPositions(t,u());r.$getModalMask().height(n(document).height()).width(n(document).width())}var f=new DMH.AnchoredElementLogic,e=null,t=null,r=new DMH.SharedElements,v=this,i=null,o=0,n=docmahJQuery;this.ClosePage=function(){l();u().hide();n(document).off("resize");r.$getModalMask().hide()};this.Initialize=function(i,r,u){e=i;b().click({model:this,hide:!1},a);d().click({model:this,hide:!0},a);e.DisableDocumentation?c().hide():c().show().click(function(){window.open(DMH.Urls.NavigateDocumentation,"_blank")});n(window).resize(rt);n(r).bind("pageUpdate.dmh",function(n,i){t=i});n(u).bind("showFirstTime.dmh",function(){v.ShowPage()})};this.ShowPage=function(i){if(i&&(t=i),t){l();nt().html(t.Content);k().html(t.Title);var e=u();f.UpdateElementPosition(t,e);r.$getModalMask().height(n(document).height()).width(n(document).width());o=0;h().empty();n.each(t.Bullets,function(n,t){it(t)});r.$getModalMask().show();e.show()}};this.ShowPageFirstTime=function(n,r){i=r;t=n;var u=new DMH.Cookies;t&&u.GetCookie("DMH-HideHelp")!=="true"&&(i===null||!i.HidePage)&&this.ShowPage()}};DMH.SharedElements=function(){var n=docmahJQuery;this.$getModalMask=function(){return n("#dmhModalMask")}};

